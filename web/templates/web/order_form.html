{% extends "web/base.html" %}
{% block content %}
<div class="container mt-4">
  <h4 class="mb-3">New Order for {{ customer.name }}</h4>

  <form method="post">
    {% csrf_token %}

    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">{{ form.customer.label }}</label>
        {{ form.customer }}
      </div>
      <div class="col-md-8">
        <label class="form-label">{{ form.notes.label }}</label>
        {{ form.notes }}
      </div>
    </div>

    <h5 class="mt-3">Items</h5>
    {{ formset.management_form }}

    <div class="table-responsive">
      <table class="table table-bordered align-middle" id="items-table">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th style="width:140px;">Qty</th>
            <th style="width:180px;">Unit Price</th>
            <th style="width:70px;">X</th>
          </tr>
        </thead>
        <tbody id="form-area">
          {% for f in formset %}
            <tr class="form-row">
              <td>{{ f.product }}</td>
              <td>{{ f.quantity }}</td>
              <td>{{ f.unit_price }}</td>
              <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-form" title="Remove">×</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex gap-2">
      <button type="button" id="add-form" class="btn btn-outline-primary">+ Add Another Item</button>
      <button type="submit" class="btn btn-primary">Save Order</button>
    </div>
  </form>
</div>

{# Prototype row for JS #}
<script type="text/template" id="empty-form-template">
<tr class="form-row">
  <td>{{ formset.empty_form.product|safe }}</td>
  <td>{{ formset.empty_form.quantity|safe }}</td>
  <td>{{ formset.empty_form.unit_price|safe }}</td>
  <td class="text-center">
    <button type="button" class="btn btn-sm btn-outline-danger remove-form" title="Remove">×</button>
  </td>
</tr>
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const formArea = document.getElementById("form-area");
  const addBtn   = document.getElementById("add-form");

  // IMPORTANT: tumia prefix ulioweka kwenye view
  const totalForms = document.getElementById("id_{{ prefix }}-TOTAL_FORMS");
  let formIdx = parseInt(totalForms.value || "0", 10);

  function addRow() {
    let tmpl = document.getElementById("empty-form-template").innerHTML;
    tmpl = tmpl.replace(/__prefix__/g, String(formIdx));
    formArea.insertAdjacentHTML("beforeend", tmpl);
    formIdx += 1;
    totalForms.value = String(formIdx);
  }

  // Ikiwa hakuna form kabisa, onyesha angalau 1
  if (formIdx === 0) {
    addRow();
  }

  addBtn.addEventListener("click", addRow);

  // Remove row (for new rows only on create page)
  formArea.addEventListener("click", function(e) {
    if (!e.target.classList.contains("remove-form")) return;
    const row = e.target.closest(".form-row");
    row.remove();
    formIdx = Math.max(0, formIdx - 1);
    totalForms.value = String(formIdx);
  });
});
</script>
{% endblock %}
