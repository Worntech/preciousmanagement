{% extends "web/base.html" %}
{% block title %}Find a Farmer — Honey ERP{% endblock %}
{% block content %}
{% include "web/_styles.html" %}

{% if designation == "CEO" or designation == "Manager" or designation == "Vendors" or designation == "Marketing Officer" or designation == "Finance Officer" or designation == "Store Keeper" %}
<div class="container py-4 honey-bg rounded">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="honey-text mb-0"><i class="ri-search-line"></i> Find a Farmer</h3>
    <span class="text-muted small">Search by first, middle, or last name</span>
  </div>

  <form method="post" class="row g-2 mb-3">
    {% csrf_token %}
    <div class="col-md-10">
      <input type="text" name="query" class="form-control" placeholder="e.g. John, Ayo, or Mushi" required>
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-outline-secondary" type="submit">
        <i class="ri-search-line"></i> Search
      </button>
    </div>
  </form>

  {% comment %} {# ----------------------------- #
     SEARCH RESULTS (only if searching)
     If `farmers` is not None, show results only
     ----------------------------- #} {% endcomment %}
  {% if farmers is not None %}
    {% if farmers %}
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0">Search Results</h6>
        <span class="text-muted small">{{ farmers|length }} match{{ farmers|length|pluralize }}</span>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="min-width:240px">Name</th>
              <th>Phone</th>
              <th>Village / District</th>
              <th class="text-end" style="width:260px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for f in farmers %}
            <tr>
              <td>
                <div class="fw-semibold">
                  {{ f.first_name }} {% if f.middle_name %}{{ f.middle_name }}{% endif %} {{ f.last_name }}
                </div>
                {% if f.card_number %}
                  <div class="text-muted small">Card: {{ f.card_number }}</div>
                {% endif %}
              </td>
              <td>{{ f.mobile_number|default:"—" }}</td>
              <td>
                {% if f.village %}{{ f.village }}{% else %}—{% endif %}
                {% if f.district %}, {{ f.district }}{% endif %}
              </td>
              <td class="text-end">
                <a class="btn btn-sm honey-btn text-white" href="{% url 'add_purchase' f.id %}">
                  <i class="ri-shopping-cart-2-line"></i> Start Purchase
                </a>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'farmer_purchases' f.id %}">
                  <i class="ri-file-list-2-line"></i> History
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-4">
        <i class="ri-emotion-unhappy-line fs-2 d-block mb-2 text-muted"></i>
        <div class="text-muted">No farmers matched your search.</div>
      </div>
    {% endif %}
  {% endif %}

  {% comment %} {# ----------------------------- #
     DEFAULT LIST (only when NOT searching)
     Requires `all_farmers` from the view.
     ----------------------------- #} {% endcomment %}
  {% if farmers is None and all_farmers %}
    <hr class="my-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h6 class="mb-0"><i class="ri-group-line"></i> All Farmers</h6>
      <span class="text-muted small">Showing {{ all_farmers|length }}</span>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th style="min-width:240px">Name</th>
            <th>Phone</th>
            <th>Village / District</th>
            <th class="text-end" style="width:260px;"></th>
          </tr>
        </thead>
        <tbody>
          {% for f in all_farmers %}
          <tr>
            <td>
              <div class="fw-semibold">
                {{ f.first_name }} {% if f.middle_name %}{{ f.middle_name }}{% endif %} {{ f.last_name }}
              </div>
              {% if f.card_number %}
                <div class="text-muted small">Card: {{ f.card_number }}</div>
              {% endif %}
            </td>
            <td>{{ f.mobile_number|default:"—" }}</td>
            <td>
              {% if f.village %}{{ f.village }}{% else %}—{% endif %}
              {% if f.district %}, {{ f.district }}{% endif %}
            </td>
            <td class="text-end">
              <a class="btn btn-sm honey-btn text-white" href="{% url 'add_purchase' f.id %}">
                <i class="ri-shopping-cart-2-line"></i> Start Purchase
              </a>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'farmer_purchases' f.id %}">
                <i class="ri-file-list-2-line"></i> History
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="text-muted small">Tip: use the search above to quickly find a specific farmer.</div>
  {% endif %}
</div>
{% endif %}

<style>
/* Extra polish to match “honey” look */
.honey-bg { background: #fffdf6; }
.honey-text { color: #a16207; }
.honey-btn {
  background: #fbbf24;
  border-color: #f59e0b;
}
.honey-btn:hover { opacity: .95; color: #fff; }
.table th, .table td { vertical-align: middle; }
</style>
{% endblock %}
