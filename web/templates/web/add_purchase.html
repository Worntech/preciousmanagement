{% extends "web/base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex align-items-center justify-content-between mb-2">
    <h4 class="mb-0">Start Purchase for {{ farmer.first_name }} {{ farmer.last_name }}</h4>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'purchase_search' %}">← Search another farmer</a>
  </div>

  <form method="post" class="mt-3">
    {% csrf_token %}
    {{ formset.management_form }}

    {% if formset.non_form_errors %}
      <div class="alert alert-danger mb-2">{{ formset.non_form_errors }}</div>
    {% endif %}

    <div class="table-responsive">
      <table class="table table-bordered align-middle" id="purchase-table">
        <thead class="table-light">
          <tr>
            <th style="width: 28%">Barcode</th>
            <th style="width: 32%">Product</th>
            <th style="width: 15%">Quantity</th>
            <th style="width: 15%">Unit Price</th>
            <th style="width: 10%">Remove</th>
          </tr>
        </thead>
        <tbody id="form-area">
          {% for form in formset %}
            <tr class="form-row">
              {{ form.id }}

              <td>
                {{ form.barcode_data }}
                {% for e in form.barcode_data.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </td>

              <td>
                {{ form.product_name }}
                {% for e in form.product_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </td>

              <td>
                {{ form.quantity }}
                {% for e in form.quantity.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </td>

              <td>
                {{ form.unit_price }}
                {% for e in form.unit_price.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
              </td>

              <td class="text-center">
                {% if form.DELETE %}{{ form.DELETE.as_hidden }}{% endif %}
                <button type="button" class="btn btn-sm btn-danger remove-form" title="Remove row">✖</button>
              </td>
            </tr>

            {% for e in form.non_field_errors %}
              <tr><td colspan="5"><div class="alert alert-danger mb-2">{{ e }}</div></td></tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="d-flex gap-2">
      <button type="button" id="add-form" class="btn btn-outline-primary">
        <i class="ri-add-circle-line"></i> Add Another Item
      </button>

      <button type="submit" name="action" value="save_finish" class="btn btn-primary" id="save-btn">
        Save & Review
      </button>
    </div>
  </form>
</div>

{# --------- Template row kwa kuongeza item mpya --------- #}
<script type="text/template" id="empty-form-template">
<tr class="form-row">
  <td>{{ formset.empty_form.barcode_data|safe }}</td>
  <td>{{ formset.empty_form.product_name|safe }}</td>
  <td>{{ formset.empty_form.quantity|safe }}</td>
  <td>{{ formset.empty_form.unit_price|safe }}</td>
  <td class="text-center">
    <button type="button" class="btn btn-sm btn-danger remove-form" title="Remove row">✖</button>
  </td>
</tr>
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const formArea   = document.getElementById("form-area");
  const addBtn     = document.getElementById("add-form");

  // IMPORTANT: prefix = "items" → id_items-TOTAL_FORMS
  const totalForms = document.getElementById("id_items-TOTAL_FORMS");
  let formIdx = parseInt(totalForms?.value || "0", 10);

  function buildRowHtml(index) {
    let tmpl = document.getElementById("empty-form-template").innerHTML;
    return tmpl.replace(/__prefix__/g, String(index));
  }

  // Auto-ongeza row 1 kama hakuna forms kabisa (extra=0 + pending tupu)
  if (formIdx === 0) {
    formArea.insertAdjacentHTML("beforeend", buildRowHtml(0));
    formIdx = 1;
    totalForms.value = "1";
  }

  // Ongeza row mpya
  addBtn?.addEventListener("click", function() {
    formArea.insertAdjacentHTML("beforeend", buildRowHtml(formIdx));
    formIdx += 1;
    totalForms.value = String(formIdx);
  });

  // Futa row: existing (mark DELETE) vs mpya (ondoa na punguza TOTAL_FORMS)
  formArea.addEventListener("click", function(e) {
    if (!e.target.classList.contains("remove-form")) return;
    const row = e.target.closest(".form-row");
    const deleteField = row.querySelector('input[name$="-DELETE"]');

    if (deleteField) {
      if (deleteField.type === "checkbox") deleteField.checked = true;
      else deleteField.value = "on";
      row.style.display = "none";
    } else {
      row.remove();
      formIdx = Math.max(0, formIdx - 1);
      totalForms.value = String(formIdx);
    }
  });

  // UX: epuka double submit
  document.addEventListener("submit", function(){
    const btn = document.getElementById("save-btn");
    if (btn) { btn.disabled = true; btn.innerText = "Saving..."; }
  });
});
</script>
{% endblock %}
